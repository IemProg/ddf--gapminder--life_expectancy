info:
    id: ddf--gapminder--life_expectancy
    base:
        - &hist open-numbers/ddf--gapminder--life_expectancy_historic
        - &geo open-numbers/ddf--gapminder--geo_entity_domain
        - &ihme open-numbers/ddf--ihme--lex

config: {}


ingredients:
    - id: ihme-datapoints
      dataset: *ihme
      key: location,sex,age,year
      value:
          - mean
    - id: ihme-locations
      dataset: *ihme
      key: location

    - id: gm-hist-datapoints
      dataset: *hist
      key: area, year
      value:
          - life_expectancy_with_interpolations
    - id: gm-hist-areas
      dataset: *hist
      key: area

    - id: geo-entities
      dataset: *geo
      key: country
      value: "*"

    - id: concepts-to-serve
      key: concept
      data:
        -
            concept: life_expectancy
            concept_type: measure
            name: Life expectancy
            unit: years
            indicator_url: https://github.com/open-numbers/ddf--gapminder--life_expectancy
        -
            concept: indicator_url
            name: Indicator URL
            concept_type: string
        -
            concept: unit
            concept_type: string
            name: Unit
        -
            concept: country
            concept_type: entity_domain
            name: Country
        -
            concept: year
            concept_type: time
            name: Year
        -
            concept: geo
            concept_type: entity_domain
            name: Geo
        -
            concept: name
            concept_type: string
            name: Name

cooking:
    datapoints:
        # 1. align both ihme, hist to gm-geo
        # 2. for ihme, filter sex=both_sexes, age=22(all ages)
        # 3. deep merge
        - procedure: translate_column
          ingredients:
              - gm-hist-areas
          options:
              column: name
              target_column: geo
              dictionary:
                  key: ['name', 'gapminder_list','alternative_1', 'alternative_2', 'alternative_3',
                        'alternative_4_cdiac', 'pandg', 'god_id', 'alt_5', 'upper_case_name', 'arb1',
                        'arb2', 'arb3', 'arb4', 'arb5', 'arb6']
                  value: country
                  base: geo-entities
              not_found: drop
              ignore_case: true
          result: gm-hist-areas-aligned

        - procedure: translate_column
          ingredients:
              - ihme-locations
          options:
              column: medium_name
              target_column: geo
              dictionary:
                  key: ['name', 'gapminder_list','alternative_1', 'alternative_2', 'alternative_3',
                        'alternative_4_cdiac', 'pandg', 'god_id', 'alt_5', 'upper_case_name', 'arb1',
                        'arb2', 'arb3', 'arb4', 'arb5', 'arb6']
                  value: country
                  base: geo-entities
              not_found: drop
              ignore_case: true
          result: ihme-locations-aligned

        - procedure: translate_column
          ingredients:
              - gm-hist-datapoints
          options:
              column: area
              dictionary:
                  key: area
                  value: geo
                  base: gm-hist-areas-aligned
          result: gm-hist-datapoints-aligned

        - procedure: filter
          ingredients:
              - ihme-datapoints
          options:
              row:
                  $and:
                      sex:
                          $eq:
                              "3"
                      age:
                          $eq:
                              "22"
          result: ihme-datapoints-filtered

        - procedure: flatten
          ingredients:
              - ihme-datapoints-filtered
          options:
              flatten_dimensions:
                  - sex
                  - age
              dictionary:
                  "*": "{concept}"
          result: ihme-datapoints-flattened

        - procedure: translate_column
          ingredients:
              - ihme-datapoints-flattened
          options:
              column: location
              dictionary:
                  key: location
                  value: geo
                  base: ihme-locations-aligned
          result: ihme-datapoints-aligned

        # translate header and merge
        - procedure: translate_header
          ingredients:
              - ihme-datapoints-aligned
          options:
              dictionary:
                  location: country
                  mean: life_expectancy
          result: ihme-datapoints-final
        - procedure: translate_header
          ingredients:
              - gm-hist-datapoints-aligned
          options:
              dictionary:
                  area: country
                  life_expectancy_with_interpolations: life_expectancy
          result: gm-hist-datapoints-final

        - procedure: merge
          ingredients:
              - gm-hist-datapoints-final
              - ihme-datapoints-final
          options:
              deep: true
          result: datapoints-to-serve

    entities:
        - procedure: filter
          ingredients:
              - geo-entities
          options:
              item:
                - country
                - name
          result: geo-entities-filtered

        - procedure: serve
          ingredients:
              - geo-entities-filtered
          options:
            no_keep_sets: true

    concepts:
        - procedure: serve
          ingredients:
              - concepts-to-serve
